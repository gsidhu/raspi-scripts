# Set up Tailscale VPN

## Sign up for Tailscale
1. **Create a Tailscale account** at [Tailscale's website](https://tailscale.com/).
2. **Log in** to your Tailscale account.

The rest is just following the instructions in the sign up process.

## 1. Install on your main computer (MacOS)
1. **Download and install the MacOS Tailscale app** from [Tailscale's website](https://tailscale.com/download).
2. **Open the Tailscale app**.
3. **Log in** to your Tailscale account.
4. **Authorize your device**:
  - You will be prompted to authorize your Mac in the Tailscale app.
  - Follow the instructions to complete the authorization.
5. **Install the Tailscale CLI**:
  - Open Settings in the Tailscale app.
  - Click on "Show me how" next to CLI Integration.
  - Follow the instructions to install the Tailscale CLI.

## 2. Install on the Raspberry Pi
1. **Install Tailscale**:
```bash
curl -fsSL https://tailscale.com/install.sh | sh
```
2. **Start Tailscale**:
```bash
sudo tailscale up
```
3. **Authenticate**:
You will be prompted to authenticate your device by visiting a URL in your web browser. Open that link on your main computer.

## Verifying the Setup
(Option 1) Running `tailscale status` on either your Mac or Raspberry Pi should show the status of your Tailscale connection and the devices connected to your Tailscale network.

(Option 2) You can also check the Tailscale admin console at [Tailscale Admin Console](https://login.tailscale.com/admin/machines) to see your devices and their status.

## (Optional) Use the Raspberry Pi as a Tailscale exit node
Setting up your Raspberry Pi as an exit node allows you to route all your internet traffic through it when connected to Tailscale. This is useful when you want to access the internet as if you were on your home network.

1. Go to the Tailscale admin console at [Tailscale Admin Console](https://login.tailscale.com/admin/machines).
2. Follow the steps from [Tailscale's documentation](https://tailscale.com/kb/1408/quick-guide-exit-nodes?tab=linux) to set up your Raspberry Pi as an exit node. Currently they are:

```bash
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf
sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
sudo tailscale set --advertise-exit-node
```

- Go to the [Machines](https://login.tailscale.com/admin/machines) page of the admin console.
- Locate the device in the list. It should display the **Exit Node** badge.
- Select the ellipsis icon menu, then select **Edit route settings**.
- Check the **Use as exit node** box, then select **Save**.

Now when you are connected to a public Wi-Fi network, you can route your internet traffic through your Raspberry Pi by selecting it as an exit node in the Tailscale app on your main computer.

## (Optional) Set up HTTPS and serve your Pi's services securely

If you want to access your Raspberry Pi's services over HTTPS using Tailscale, you can set up HTTPS certificates. This is useful for secure access to web services running on your Raspberry Pi.

1. Go to the DNS page of the Tailscale admin console at [Tailscale Admin Console](https://login.tailscale.com/admin/dns).
2. Make sure **MagicDNS** is enabled.
3. Click on **Enable HTTPS**.
4. On the Raspberry Pi, run the following command to enable HTTPS:
```bash
sudo tailscale cert <MACHINE_DOMAIN_NAME>
```

Replace `<MACHINE_DOMAIN_NAME>` with the domain name of your machine, which you can find in the Tailscale admin console under the **Machines** section. It'll look something like `raspberrypi.tailnet.ts.net`.

5. This generates a HTTPS certificate and key file in the directory you ran the command from. This certificate has a 90-day validity period. You can renew it by running the same command again.
6. On Raspberry Pi, you have to move these files to a location where your web server/services can access them. Simply â€“
```bash
mkdir ~/.config/ssl
mv <CERTIFICATE_FILENAME>.crt ~/.config/ssl/
mv <KEY_FILENAME>.key ~/.config/ssl/
```

### Serving a FastAPI app over HTTPS

Simply edit the `uvicorn` command to include the certificate and key files:

```bash
# Replace <KEY_FILENAME> and <CERTIFICATE_FILENAME> with the actual filenames generated by Tailscale
uvicorn main:app --host 0.0.0.0 --port 443 --ssl-keyfile ~/.config/ssl/<KEY_FILENAME>.key --ssl-certfile ~/.config/ssl/<CERTIFICATE_FILENAME>.crt
```

### Adding the certificates to an NGINX server block

If you're using NGINX to serve your Raspberry Pi's web services, you can add the HTTPS certificates to your NGINX server block:
```nginx
server {
    listen 443 ssl;
    server_name <MACHINE_DOMAIN_NAME>;

    # Add your certificate and key file paths here
    ssl_certificate /etc/ssl/certs/<CERTIFICATE_FILENAME>.crt;
    ssl_certificate_key /etc/ssl/private/<KEY_FILENAME>.key;

    location / {
        proxy_pass http://localhost:8000;
    }
}
```